<!DOCTYPE html> <html lang="zh-CN" dir="ltr"> <head> <meta charset="UTF-8"> <!-- SEO --> <title>权限 - Nop</title> <meta property="og:title" content="权限"> <meta name="description" content="启用权限"> <meta property="og:description" content="启用权限"> <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程"> <link rel="canonical" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/auth/auth/"> <meta property="og:url" content="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/auth/auth/"> <meta property="og:site_name" content="Nop"> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "WebSite", "name" : "Nop", "url" : "https://nop-platform.gitee.io" } </script> <meta property="og:type" content="article"> <meta property="article:published_time" content="2024-04-13T09:39:39+08:00"> <link rel="next" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/auth/impersonate/" title="替代登录"> <link rel="prev" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/core-code-guidance/" title="Nop平台核心代码阅读导引"> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "NewsArticle", "headline": "权限", "image": null, "datePublished": "2024-04-13T09:39:39+08:00", "description": "启用权限" } </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Organization", "url": "https://nop-platform.gitee.io", "logo": "https://nop-platform.gitee.io/assets/logo-9952a8b58c6582fc86a9608db8113158fb31de7a9db19d4358ac7cb96578d34e.png" } </script> <link rel="author" href="https://nop-platform.gitee.io"> <!-- 页面渲染兼容性 --> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> <meta name="theme-color" content="#0871ab"> <link rel="icon" href="/assets/logo-9952a8b58c6582fc86a9608db8113158fb31de7a9db19d4358ac7cb96578d34e.png"> <!-- 静态资源 --> <link type="text/css" rel="stylesheet" href="/assets/global-f979fafa22c865e727cd15f83cdc43dbc73c1a324d7ad4fe6fa48e275dc4c063.css"> <link type="text/css" rel="stylesheet" href="/assets/ksio/vendors/share-c2e41222f5f34b2de38cb5213fa0e439c11da73b3907b444a32635563ae85ffd.css"> <link type="text/css" rel="stylesheet" href="/assets/local/layouts/doc-c5c0ab8b12485893472e680b5f067b74e240481232265b6cb0ab6edc95c20f65.css"> <script type="text/javascript" src="/assets/global-b3a80dd53acf48ad7228d6fd741dba15d3845cbc3783bdbbf7244151a45628aa.js"></script> <!--[if lt IE 9]> <script type="text/javascript" src="/assets/ksio/support_ie8-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script> <![endif]--> </head> <body class="Page" itemscope itemtype="http://schema.org/WebPage"> <header class="Page-header"> <div class="navbar navbar-static-top"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse"> <span class="sr-only">Toggle navs</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">Nop</a> </div> <!-- Nav menus --> <nav class="Page-navs navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/nop-entropy/docs/">指南</a> </li> <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">文章</a> </li> <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">视频</a> </li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/nop-entropy/">Nop Entropy</a> </li> <li><a href="/projects/nop-chaos/">Nop Chaos</a> </li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/community/">社区</a> </li> <li><a href="/team/">团队</a> </li> <li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">Gitee 组织</a> </li> </ul> </li> <li><a href="https://nop-platform.github.io?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">English</a> </li> </ul> </nav> </div> </div> </header> <div class="Page-content"> <aside class="Page-aside"> <div class="AsideBrand"> <a href="/">Nop</a> </div> <nav class="AsideNav"><ul> <li> <a href="/projects/nop-entropy/docs/why-nop/">介绍</a> <ul> <li> <a href="/projects/nop-entropy/docs/">文档概览</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/tutorial/">入门教程</a> <ul> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">极简服务层开发</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">极简数据访问层开发</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/compare/">与其他平台的对比</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a> <ul> <li> <a href="/projects/nop-entropy/docs/user-guide/installation/">安装和配置</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/report/">报表引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">IDEA插件使用</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">监控</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/arch/">软件架构</a> <ul> <li> <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a> </li> <li> <a href="/projects/nop-entropy/docs/core-code-guidance/">核心代码阅读导引</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/theory/">理论基础</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/codegen/">代码生成器</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/cli/">命令行工具</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行开发支持</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/config/">配置管理</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/ioc/">IoC容器</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">AOP支持</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/">ORM框架</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang语言</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL领域语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript脚本语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">Xpl模板语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">元编程</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/">GraphQL引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/">分布式微服务</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">规则引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动化测试</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/tenant/">多租户</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">Delta定制</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/vfs/">Delta文件系统</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/">权限配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/biz/">业务规则</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/nocode/">动态模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/">前端模型</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/integration/">第三方集成</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/spring/">spring集成</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">quarkus集成</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">IDEA插件</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">插件开发</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a> <ul> <li> <a href="/projects/nop-entropy/docs/faq/debug-errors/">错误诊断</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/">常见问题解决方案</a> </li> </ul> </li> </ul> </nav> </aside> <main class="Page-main"> <article class="Article container-fluid"> <header class="Article-header"> <h1 class="Article-title">权限</h1> </header> <div class="Article-content col-md-9"><h2 id="section">启用权限</h2> <ul> <li>配置<code>nop.auth.enable-action-auth=true</code>后启用操作权限。字段级别权限也利用这一开关</li> <li>配置<code>nop.auth.enable-data-auth=true</code>后启用数据权限。</li> <li>配置<code>nop.auth.use-data-auth-table=true</code>启用数据权限配置表<code>NopAuthRoleDataAuth</code>，数据库中配置的数据权限规则可以和配置文件中的权限规则合并</li> <li>缺省会加载/nop/main/auth/main.action-auth.xml 静态权限配置文件，可以通过nop.auth.site-map.static-config-path定制为不同的值</li> <li>在main.action-auth.xml可以通过<code>x:extends</code>来引入已有的权限配置文件。</li> <li>如果配置<code>nop.auth.skip-check-for-admin=true</code>,则对于具有admin角色的用户会跳过操作权限检查，缺省为true。</li> <li>配置<code>nop.auth.service-public=true</code>可以开放后台服务，无需登录即可访问后台服务函数</li> <li>配置<code>nop.auth.quarkus-dev-public=true</code>会开放quarkus调试页面，无需登录即可访问/q/graphql-ui等调试页面</li> </ul> <blockquote> <p>平台在调试模式下启动时会打印出所有已知配置变量以及它对应的配置位置</p> </blockquote> <h2 id="section-1">核心接口</h2> <ol> <li><code>IUserContext</code>: 保存<code>userId</code>, <code>roles</code>等用户身份和权限相关信息。通过<code>IUserContext.set()/get()</code>函数存取。</li> <li><code>IActionAuthChecker</code>: 检查操作权限和字段权限。在<code>GraphQLExecutor</code>中针对每个GraphQL field调用。</li> <li><code>IDataAuthChecker</code>: 检查数据权限。在<code>CrudBizModel</code>中为<code>Query</code>对象自动追加权限过滤条件，在获取到每个实体后执行<code>check</code>动作。</li> <li>登录验证在<code>AuthHttpServerFilter</code>类中通过<code>ILoginService</code>接口调用实现。</li> <li><code>ILoginService</code>接口负责登入登出和<code>token</code>校验相关的所有逻辑。平台内置了<code>LoginServiceImpl</code>和<code>OAuthLoginServiceImpl</code>两个实现。</li> </ol> <h2 id="section-2">操作权限</h2> <h3 id="section-3">操作权限配置</h3> <p>通过<code>action-auth.xml</code>和<code>NopAuthResource</code>后台对象可以配置操作权限。<code>resource</code>的类型分为<code>TOPM</code>、<code>SUBM</code>和<code>FNPT</code>，分为对应于顶级菜单、子菜单和功能点。在功能点上可以标记对应的<code>permissions</code>。</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;resource</span> <span class="na">id=</span><span class="s">&quot;NopAuthDept-main&quot;</span> <span class="na">displayName=</span><span class="s">&quot;部门&quot;</span> <span class="na">orderNo=</span><span class="s">&quot;10001&quot;</span> <span class="na">i18n-en:displayName=</span><span class="s">&quot;Department&quot;</span>
          <span class="na">icon=</span><span class="s">&quot;ant-design:appstore-twotone&quot;</span> <span class="na">component=</span><span class="s">&quot;AMIS&quot;</span> <span class="na">resourceType=</span><span class="s">&quot;SUBM&quot;</span>
          <span class="na">url=</span><span class="s">&quot;/nop/auth/pages/NopAuthDept/main.page.yaml&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;children&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">id=</span><span class="s">&quot;FNPT:NopAuthDept:query&quot;</span> <span class="na">displayName=</span><span class="s">&quot;查询部门&quot;</span> <span class="na">orderNo=</span><span class="s">&quot;10002&quot;</span> <span class="na">resourceType=</span><span class="s">&quot;FNPT&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;permissions&gt;</span>NopAuthDept:query<span class="nt">&lt;/permissions&gt;</span>
        <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">id=</span><span class="s">&quot;FNPT:NopAuthDept:update&quot;</span> <span class="na">displayName=</span><span class="s">&quot;修改部门&quot;</span> <span class="na">orderNo=</span><span class="s">&quot;10003&quot;</span> <span class="na">resourceType=</span><span class="s">&quot;FNPT&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;permissions&gt;</span>NopAuthDept:update<span class="nt">&lt;/permissions&gt;</span>
        <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;resource</span> <span class="na">id=</span><span class="s">&quot;FNPT:NopAuthDept:delete&quot;</span> <span class="na">displayName=</span><span class="s">&quot;删除部门&quot;</span> <span class="na">orderNo=</span><span class="s">&quot;10004&quot;</span> <span class="na">resourceType=</span><span class="s">&quot;FNPT&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;permissions&gt;</span>NopAuthDept:delete<span class="nt">&lt;/permissions&gt;</span>
        <span class="nt">&lt;/resource&gt;</span>
    <span class="nt">&lt;/children&gt;</span>
<span class="nt">&lt;/resource&gt;</span></code></pre></figure> <p>然后系统后台可以配置用户角色和<code>NopAuthResource</code>的对应关系，用于控制用户能访问哪些菜单，再由此推断出用户具有哪些<code>permission</code>。</p> <ol> <li>菜单项对应的<code>resourceType=SUBM</code>， 页面中对应的具体的功能点（例如修改按钮）对应<code>resourceType=FNPT</code></li> <li>如果使用amis页面，需要配置<code>component=AMIS</code>，<code>url=页面的虚拟文件路径</code></li> </ol> <h3 id="section-4">通过界面配置权限</h3> <p>先不要开启操作权限，通过界面增加admin角色，然后给指定用户分配admin角色，此后再开启操作权限。通过具有admin角色的用户给其他用户分配角色， 并为角色指定它所能访问的NopAuthResource。</p> <p>NopAuthResource按照siteId进行组织，缺省使用siteId=MAIN作为主站点的网站菜单。nop-auth支持同时管理多个前端应用所对应的菜单链接。 比如siteId=mobile可以用于移动端菜单，而siteId=MAIN用于Web端等。</p> <h3 id="action">后台Action</h3> <p>在action函数上通过<code>@Auth</code>注解来指定需要对应的<code>permissions</code>或者允许访问的<code>roles</code>。如果不指定，则按照是否是<code>@BizQuery</code> 或者<code>@BizMutation</code>自动设置<code>permissions</code>为<code>{BizObjName}:{actionName}|{BizObjName}:query</code>，以及<code>{BizObjName}:{actionName}|{BizObjName}:mutation</code></p> <p>在权限分配的时候，如果允许所有读取操作，则可以配置<code>{BizObjName}:query</code>，这样就不需要挨个指定<code>{actionName}</code></p> <p>例如</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="err">@</span><span class="nx">Auth</span><span class="p">(</span><span class="nx">permissions</span><span class="o">=</span><span class="s2">&quot;delete&quot;</span><span class="p">)</span>
<span class="err">@</span><span class="nx">BizMutation</span>
<span class="kr">public</span> <span class="kr">boolean</span> <span class="ow">delete</span><span class="p">(</span><span class="err">@</span><span class="nx">Name</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span> <span class="err">@</span><span class="nx">Description</span><span class="p">(</span><span class="s2">&quot;@i18n:biz.id|对象的主键标识&quot;</span><span class="p">)</span> <span class="nb">String</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">IServiceContext</span> <span class="nx">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="ow">delete</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure> <p><code>permission</code>的完整格式为<code>bizObjName:action</code>，如果只写action部分，则会自动补充<code>bizObjName</code>前缀。例如上面配置的<code>permissions="delete"</code>最终转换得到的 可能是<code>NopAuthUser:delete</code>。</p> <p>如果在action上不标注<code>@Auth</code>注解，则缺省对应的<code>permission</code>为<code>{bizObjName}:mutation</code>或者<code>{bizObjName}:query</code>。</p> <p>在xbiz文件中可以为对应action设置<code>auth</code>配置，它会覆盖同名的Java方法上通过<code>@Auth</code>注解引入的权限设置。例如</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;mutation</span> <span class="na">name=</span><span class="s">&quot;delete&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;auth</span> <span class="na">permissions=</span><span class="s">&quot;delete&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/mutation&gt;</span></code></pre></figure> <h3 id="section-5">结果对象上的属性</h3> <p>在xmeta文件中，可以为<code>prop</code>指定<code>auth</code>设置</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;prop</span> <span class="na">name=</span><span class="s">&quot;xx&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;auth</span> <span class="na">permissions=</span><span class="s">&quot;NopAuthUser:query&quot;</span> <span class="na">roles=</span><span class="s">&quot;admin&quot;</span> <span class="na">for=</span><span class="s">&quot;read&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;auth</span> <span class="na">permissions=</span><span class="s">&quot;NopAuthUser:mutation&quot;</span> <span class="na">roles=</span><span class="s">&quot;hr&quot;</span> <span class="na">for=</span><span class="s">&quot;write&quot;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/prop&gt;</span></code></pre></figure> <p>通过这里的配置可以实现字段级别的读写权限控制. <code>for="read"</code>表示控制字段读权限，<code>for="write"</code>控制字段写权限，而<code>for="all"</code>同时允许读和写</p> <h3 id="section-6">公开访问</h3> <p>如果<code>@Auth</code>注解或者xbiz中的auth配置指定了publicAccess=true，则该方法为公开可访问方法，会自动跳过操作权限检查。但是数据权限仍然会应用。</p> <p>所有的用户都自动具有角色user，所以如果配置<code>@Auth(roles="user")</code>则表示允许所有登录用户访问。这种方式与publicAccess的区别在于，如果标记为 publicAccess的方法不会检查当前访问用户是否已经登录。</p> <h2 id="section-7">操作权限检查接口</h2> <p>系统通过<code>IActionAuthChecker</code>接口来检查操作权限。</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IActionAuthChecker</span> <span class="p">{</span>
    <span class="kt">boolean</span> <span class="nf">isPermitted</span><span class="p">(</span><span class="n">String</span> <span class="n">permission</span><span class="p">,</span> <span class="n">ISecurityContext</span> <span class="n">context</span><span class="p">);</span>

    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isAllPermitted</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">permissions</span><span class="p">,</span> <span class="n">ISecurityContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">permissions</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">permissions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">String</span> <span class="n">permission</span> <span class="p">:</span> <span class="n">permissions</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isPermitted</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">default</span> <span class="kt">boolean</span> <span class="nf">isPermissionSetSatisfied</span><span class="p">(</span><span class="n">MultiCsvSet</span> <span class="n">permissionSet</span><span class="p">,</span> <span class="n">ISecurityContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">permissionSet</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">permissionSet</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">permissions</span> <span class="p">:</span> <span class="n">permissionSet</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">isAllPermitted</span><span class="p">(</span><span class="n">permissions</span><span class="p">,</span> <span class="n">context</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>根据<code>auth</code>配置进行权限校验的实现如下：</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="n">IUserContext</span> <span class="n">userContext</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="na">getUserContext</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">userContext</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
   <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;nop.err.auth.no-user-context&quot;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="na">getRoles</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">auth</span><span class="p">.</span><span class="na">getRoles</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">userContext</span><span class="p">.</span><span class="na">isUserInAnyRole</span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="na">getRoles</span><span class="p">()))</span>
       <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="na">getPermissions</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">auth</span><span class="p">.</span><span class="na">getPermissions</span><span class="p">().</span><span class="na">isEmpty</span><span class="p">())</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">checker</span><span class="p">.</span><span class="na">isPermissionSetSatisfied</span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="na">getPermissions</span><span class="p">(),</span> <span class="n">context</span><span class="p">))</span>
       <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

 <span class="k">throw</span> <span class="k">new</span> <span class="n">NopException</span><span class="p">(</span><span class="n">AuthApiErrors</span><span class="p">.</span><span class="na">ERR_AUTH_NO_PERMISSION</span><span class="p">)</span>
           <span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="n">AuthApiErrors</span><span class="p">.</span><span class="na">ARG_ACTION_NAME</span><span class="p">,</span> <span class="n">fieldName</span><span class="p">)</span>
           <span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="n">ARG_PERMISSION</span><span class="p">,</span> <span class="n">auth</span><span class="p">.</span><span class="na">getPermissions</span><span class="p">())</span>
           <span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="n">ARG_ROLES</span><span class="p">,</span> <span class="n">auth</span><span class="p">.</span><span class="na">getRoles</span><span class="p">())</span>
           <span class="p">.</span><span class="na">param</span><span class="p">(</span><span class="n">ARG_OBJ_TYPE_NAME</span><span class="p">,</span> <span class="n">objTypeName</span><span class="p">);</span></code></pre></figure> <p>判断规则：</p> <ol> <li>如果设置了<code>roles</code>，则满足角色条件则返回<code>true</code>。<code>roles</code>的配置一般是逗号分隔的字符串，具有任意一个<code>role</code>就具有对应权限</li> <li>如果设置了<code>permissions</code>，则不满足<code>permission</code>条件则返回<code>false</code>。<code>permissions</code>配置的类型一般为<code>multi-csv-set,</code>格式为<code>a,b|c,d</code>，表示<code>(a并且b)或者(c并且d)</code></li> </ol> <p>也就是说可以只配置<code>roles</code>，或者只配置<code>permissions</code>。如果只配置了<code>permissions</code>，则系统内部实现是根据<code>role</code>和<code>resource</code>之间的映射关系， 找到满足<code>permission</code>条件的所有<code>role</code>，然后再按照<code>roles</code>条件去进行权限检查。</p> <blockquote> <p>根据<code>permission</code>查找到所有的<code>role</code>这一步不依赖于具体用户，可以统一完成计算然后缓存映射结果。</p> </blockquote> <h2 id="section-8">数据权限</h2> <p>后台内置的<code>findPage</code>、<code>findList</code>和<code>findFirst</code>动作都会应用数据权限检查接口<code>IDataAuthChecker</code>。 通过<code>nop.auth.enable-data-auth</code>来启用数据权限，缺省为<code>true</code></p> <h3 id="section-9">数据权限定义文件</h3> <p>在<code>/nop/main/auth/app.data-auth.xml</code>文件中配置数据权限。<code>filter</code>段为xpl格式，输出<code>filter</code>定义节点。xpl执行时上下文具有<code>entity</code>、<code>userContext</code>等变量</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;data-auth&gt;</span>
    <span class="nt">&lt;objs&gt;</span>
        <span class="nt">&lt;obj</span> <span class="na">name=</span><span class="s">&quot;NopSysUserVariable&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;role-auths&gt;</span>
                <span class="nt">&lt;role-auth</span> <span class="na">roleId=</span><span class="s">&quot;manager&quot;</span><span class="nt">&gt;</span>
                <span class="nt">&lt;/role-auth&gt;</span>

                <span class="nt">&lt;role-auth</span> <span class="na">roleId=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;filter&gt;</span>
                        <span class="nt">&lt;eq</span> <span class="na">name=</span><span class="s">&quot;userId&quot;</span> <span class="na">value=</span><span class="s">&quot;@biz:userId&quot;</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;/filter&gt;</span>
                <span class="nt">&lt;/role-auth&gt;</span>
            <span class="nt">&lt;/role-auths&gt;</span>
        <span class="nt">&lt;/obj&gt;</span>
    <span class="nt">&lt;/objs&gt;</span>
<span class="nt">&lt;/data-auth&gt;</span></code></pre></figure> <ul> <li>针对不同的角色可以设置不同的数据权限规则。一个用户只会匹配优先级最高的一条规则（如果规则优先级相同，则按照顺序检查用户是否具有指定角色）</li> </ul> <p>在<code>filter</code>段中可以编写权限过滤条件，其中<code>value</code>部分可以使用<code>@biz:</code>为前缀的表达式变量，例如<code>@biz:userId</code>、<code>@biz:deptId</code>等。 全部可用的变量在<a href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xlang/src/main/resources/_vfs/dict/core/biz-var.dict.yaml" target="_blank" rel="external nofollow">biz-var.dict.yaml</a> 中定义。</p> <h3 id="nopauthroledataauth">通过NopAuthRoleDataAuth表来定义数据权限</h3> <p>数据库中定义的数据权限会和<code>data-auth.xml</code>配置文件中定义的权限合并。</p> <h3 id="section-10">业务场景拆分</h3> <p>经常出现一种情况是同样的业务对象在不同的业务场景中过滤条件不同，比如说每个人都可以查询自己的数据，而admin可以查询所有人的数据，但是他仍然需要一个查询自己数据的页面。 这本质上是同一个业务对象分裂为两个业务场景，一个是查询owner的数据，一个是查询全部数据。对于这种应用可以有三种解决方案：</p> <ol> <li>对象拆分 直接新建一个新的业务对象，比如MyObject_self，然后它会自动使用缺省的xmeta模型和xbiz配置。</li> </ol> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>&lt;bean id=&quot;MyObject_self&quot; class=&quot;xxx.MyObjectBizModel&quot; /&gt;</code></pre></figure> <p>如果增加MyObject_self.xmeta，则MyObject_self会使用这个meta配置，否则会使用缺省的MyObject.xmeta。对于xbiz配置，同样是这样处理。</p> <blockquote> <p>这种缺省模型的识别逻辑在BizObjectBuilder.java类中实现。</p> </blockquote> <p>对象拆分后，数据权限那里就可以配置使用不同的权限过滤条件。同时通过meta上的filter也可以直接限定过滤条件。</p> <ol> <li>如果不拆分对象，也可以在查询方法中增加过滤条件</li> </ol> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;query</span> <span class="na">name=</span><span class="s">&quot;active_findPage&quot;</span> <span class="na">x:prototype=</span><span class="s">&quot;findPage&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;source&gt;</span>
        <span class="nt">&lt;c:import</span> <span class="na">class=</span><span class="s">&quot;io.nop.auth.api.AuthApiConstants&quot;</span> <span class="nt">/&gt;</span>

        <span class="nt">&lt;bo:DoFindPage</span> <span class="na">query=</span><span class="s">&quot;${query}&quot;</span> <span class="na">selection=</span><span class="s">&quot;${selection}&quot;</span> <span class="na">xpl:lib=</span><span class="s">&quot;/nop/biz/xlib/bo.xlib&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;filter&gt;</span>
                <span class="nt">&lt;eq</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">value=</span><span class="s">&quot;${AuthApiConstants.USER_STATUS_ACTIVE}&quot;</span> <span class="nt">/&gt;</span>
            <span class="nt">&lt;/filter&gt;</span>
        <span class="nt">&lt;/bo:DoFindPage&gt;</span>
    <span class="nt">&lt;/source&gt;</span>
<span class="nt">&lt;/query&gt;</span></code></pre></figure> <p>或者在java中实现</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>public PageBean&lt;MyObject&gt; findPage_self(@Name(&quot;query&quot;)QueryBean query, FieldSelectonBean selection, IServiceContext context){
  return doFindPage(query, (q,ctx)-&gt;{
     q.addFilter(FilterBeans.eq(&quot;ownerId&quot;, ctx.getUserId());
  }, selection, context);
}</code></pre></figure> <ol> <li>通过authObjName实现数据权限配置切换 上面的第二种方法会导致data-auth.xml的配置总是应用到当前对象上。如果是不同的业务场景需要启用不同的权限配置，可以使用authObjName参数来区分。</li> </ol> <p>CrudBizModel的doFindPage0/doFindList0/doFindFirst0等方法可以通过authObjName参数指定不同于当前对象名的权限对象名，从而启用不同的数据权限配置。</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>@BizQuery
    @BizArgsNormalizer(BizConstants.BEAN_nopQueryBeanArgsNormalizer)
    @GraphQLReturn(bizObjName = BIZ_OBJ_NAME_THIS_OBJ)
    public List&lt;T&gt; findList(@Optional @Name(&quot;query&quot;) QueryBean query, FieldSelectionBean selection, IServiceContext context) {
        if (query != null)
            query.setDisableLogicalDelete(false);
        return doFindList(query, this::defaultPrepareQuery, selection, context);
    }

    @BizAction
    public List&lt;T&gt; doFindList(@Name(&quot;query&quot;) QueryBean query,
                              @Name(&quot;prepareQuery&quot;) BiConsumer&lt;QueryBean, IServiceContext&gt; prepareQuery,
                              FieldSelectionBean selection,
                              IServiceContext context) {
        return doFindList0(query, getBizObjName(), prepareQuery, selection, context);
    }

    @BizAction
    public List&lt;T&gt; doFindList0(@Name(&quot;query&quot;) QueryBean query,
                               @Name(&quot;authObjName&quot;) String authObjName,
                               @Name(&quot;prepareQuery&quot;) BiConsumer&lt;QueryBean, IServiceContext&gt; prepareQuery,
                               FieldSelectionBean selection,
                               IServiceContext context){
        ...
    }</code></pre></figure> <p>内置的findList使用doFindList函数实现，而doFindList实际是使用doFindList0，然后传入authObjName为当前业务对象名。</p> </div> <footer class="Article-footer col-md-3"> <div class="Widget"> <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/dev-guide/auth/auth.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div> </div> <section class="Widget Widget--toc"> <div class="Widget-header"> <h2 class="Widget-title">目录</h2> </div> <div class="Widget-body"></div> </section> </footer> </article> <footer class="Page-footer Footer"> <div class="container-fluid"> <div class="Footer-description"> <!-- Important links --> <nav class="Footer-navs"> <ul><li><a href="/projects/nop-entropy/docs/"><span>指南</span></a> </li><li><a href="/community/"><span>社区</span></a> </li></ul> </nav> <!-- Copyright --> <div class="Footer-copyright"> <p>&copy; 2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有 </p> </div> </div> </div> </footer> </main> </div> <script>$('table').addClass('table table-bordered')</script> <script type="text/javascript" src="/assets/ksio/vendors/share.min-3155ee636b84a04d036e0f1ba833227d3fd03a4c58a6f2e21c9ceb1c5d0198c7.js"></script><script type="text/javascript" src="/assets/ksio/components-a266f21fe1dfd61bebf40e74872cbf901eb3e201f7d33e9e5d5af9a55f4b24ea.js"></script> <script type="text/javascript" src="/assets/ksio/initializers/time-8d7a529a66ae6cb53c2283d21fd6a12c538b8473dd5bd76458366d09adce7bf6.js"></script><script type="text/javascript" src="/assets/ksio/initializers/lazyload-44b7df8a9282d598284d522e64d6be9ac88d466f3c4a734a514303e99347b2c9.js"></script> </body> </html>
