<!DOCTYPE html> <html lang="zh-CN" dir="ltr"> <head> <meta charset="UTF-8"> <!-- SEO --> <title>基本使用方式 - Nop</title> <meta property="og:title" content="基本使用方式"> <meta name="description" content="QueryBean提供了复杂查询条件封装，它所支持的查询操作符可以参考filter.xdef元模型中的定义。"> <meta property="og:description" content="QueryBean提供了复杂查询条件封装，它所支持的查询操作符可以参考filter.xdef元模型中的定义。"> <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程"> <link rel="canonical" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/orm/orm-basic/"> <meta property="og:url" content="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/orm/orm-basic/"> <meta property="og:site_name" content="Nop"> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "WebSite", "name" : "Nop", "url" : "https://nop-platform.gitee.io" } </script> <meta property="og:type" content="article"> <meta property="article:published_time" content="2024-04-13T09:39:39+08:00"> <link rel="next" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/orm/orm/" title="执行原理"> <link rel="prev" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/orm/null-value/" title="空值的处理"> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "NewsArticle", "headline": "基本使用方式", "image": null, "datePublished": "2024-04-13T09:39:39+08:00", "description": "QueryBean提供了复杂查询条件封装，它所支持的查询操作符可以参考filter.xdef元模型中的定义。" } </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Organization", "url": "https://nop-platform.gitee.io", "logo": "https://nop-platform.gitee.io/assets/logo-9952a8b58c6582fc86a9608db8113158fb31de7a9db19d4358ac7cb96578d34e.png" } </script> <link rel="author" href="https://nop-platform.gitee.io"> <!-- 页面渲染兼容性 --> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> <meta name="theme-color" content="#0871ab"> <link rel="icon" href="/assets/logo-9952a8b58c6582fc86a9608db8113158fb31de7a9db19d4358ac7cb96578d34e.png"> <!-- 静态资源 --> <link type="text/css" rel="stylesheet" href="/assets/global-f979fafa22c865e727cd15f83cdc43dbc73c1a324d7ad4fe6fa48e275dc4c063.css"> <link type="text/css" rel="stylesheet" href="/assets/ksio/vendors/share-c2e41222f5f34b2de38cb5213fa0e439c11da73b3907b444a32635563ae85ffd.css"> <link type="text/css" rel="stylesheet" href="/assets/local/layouts/doc-c5c0ab8b12485893472e680b5f067b74e240481232265b6cb0ab6edc95c20f65.css"> <script type="text/javascript" src="/assets/global-b3a80dd53acf48ad7228d6fd741dba15d3845cbc3783bdbbf7244151a45628aa.js"></script> <!--[if lt IE 9]> <script type="text/javascript" src="/assets/ksio/support_ie8-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script> <![endif]--> </head> <body class="Page" itemscope itemtype="http://schema.org/WebPage"> <header class="Page-header"> <div class="navbar navbar-static-top"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse"> <span class="sr-only">Toggle navs</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">Nop</a> </div> <!-- Nav menus --> <nav class="Page-navs navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/nop-entropy/docs/">指南</a> </li> <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">文章</a> </li> <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">视频</a> </li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/nop-entropy/">Nop Entropy</a> </li> <li><a href="/projects/nop-chaos/">Nop Chaos</a> </li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/community/">社区</a> </li> <li><a href="/team/">团队</a> </li> <li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">Gitee 组织</a> </li> </ul> </li> <li><a href="https://nop-platform.github.io?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">English</a> </li> </ul> </nav> </div> </div> </header> <div class="Page-content"> <aside class="Page-aside"> <div class="AsideBrand"> <a href="/">Nop</a> </div> <nav class="AsideNav"><ul> <li> <a href="/projects/nop-entropy/docs/why-nop/">介绍</a> <ul> <li> <a href="/projects/nop-entropy/docs/">文档概览</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/tutorial/">入门教程</a> <ul> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">极简服务层开发</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">极简数据访问层开发</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/compare/">与其他平台的对比</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a> <ul> <li> <a href="/projects/nop-entropy/docs/user-guide/installation/">安装和配置</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/report/">报表引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">IDEA插件使用</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">监控</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/arch/">软件架构</a> <ul> <li> <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a> </li> <li> <a href="/projects/nop-entropy/docs/core-code-guidance/">核心代码阅读导引</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/theory/">理论基础</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/codegen/">代码生成器</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/cli/">命令行工具</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行开发支持</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/config/">配置管理</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/ioc/">IoC容器</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">AOP支持</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/">ORM框架</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang语言</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL领域语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript脚本语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">Xpl模板语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">元编程</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/">GraphQL引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/">分布式微服务</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">规则引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动化测试</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/tenant/">多租户</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">Delta定制</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/vfs/">Delta文件系统</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/">权限配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/biz/">业务规则</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/nocode/">动态模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/">前端模型</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/integration/">第三方集成</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/spring/">spring集成</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">quarkus集成</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">IDEA插件</a> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">插件开发</a> </li> </ul> </li> <li> <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a> <ul> <li> <a href="/projects/nop-entropy/docs/faq/debug-errors/">错误诊断</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/">常见问题解决方案</a> </li> </ul> </li> </ul> </nav> </aside> <main class="Page-main"> <article class="Article container-fluid"> <header class="Article-header"> <h1 class="Article-title">基本使用方式</h1> </header> <div class="Article-content col-md-9"><p>QueryBean提供了复杂查询条件封装，它所支持的查询操作符可以参考<a href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xdefs/src/main/resources/_vfs/nop/schema/query/filter.xdef" target="_blank" rel="external nofollow">filter.xdef</a> 元模型中的定义。</p> <h2 id="section">1. 复杂查询条件</h2> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="c1">// MyBatisPlus</span>
<span class="nx">LambdaQueryWrapper</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">wrapper</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">LambdaQueryWrapper</span><span class="o">&lt;&gt;</span><span class="p">();</span>
<span class="nx">wrapper</span><span class="p">.</span><span class="nx">eq</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="nx">getUsername</span><span class="p">,</span> <span class="s2">&quot;张三&quot;</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">and</span><span class="p">(</span><span class="nx">w</span> <span class="o">-&gt;</span> <span class="nx">w</span><span class="p">.</span><span class="nx">between</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="nx">getAge</span><span class="p">,</span> <span class="mf">18</span><span class="p">,</span> <span class="mf">30</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">or</span><span class="p">().</span><span class="nx">eq</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="nx">getGender</span><span class="p">,</span> <span class="mf">1</span><span class="p">))</span>
        <span class="p">.</span><span class="nx">orderByDesc</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="nx">getCreateTime</span><span class="p">);</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">userList</span> <span class="o">=</span> <span class="nx">userMapper</span><span class="p">.</span><span class="nx">selectList</span><span class="p">(</span><span class="nx">wrapper</span><span class="p">);</span>

<span class="c1">// NopORM</span>

<span class="nx">QueryBean</span> <span class="nx">query</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">QueryBean</span><span class="p">();</span>
<span class="nx">query</span><span class="p">.</span><span class="nx">addFilter</span><span class="p">(</span><span class="nx">eq</span><span class="p">(</span><span class="nx">PROP_Name_username</span><span class="p">,</span><span class="s2">&quot;张三&quot;</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">addFilter</span><span class="p">(</span><span class="nx">and</span><span class="p">(</span>
      <span class="nx">or</span><span class="p">(</span>
        <span class="nx">between</span><span class="p">(</span><span class="nx">PROP_NAME_age</span><span class="p">,</span> <span class="mf">18</span><span class="p">,</span><span class="mf">30</span><span class="p">),</span>
        <span class="nx">eq</span><span class="p">(</span><span class="nx">PROP_NAME_gender</span><span class="p">,</span> <span class="mf">1</span><span class="p">)</span>
      <span class="p">)))</span>
     <span class="p">.</span><span class="nx">addOrderField</span><span class="p">(</span><span class="nx">PROP_NAME_createTime</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      
<span class="nx">IEntityDao</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">dao</span> <span class="o">=</span> <span class="nx">daoProvider</span><span class="p">.</span><span class="nx">daoFor</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="kd">class</span><span class="p">);</span>      
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">usreList</span> <span class="o">=</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">findAllByQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>      

<span class="c1">// 如果分页查询</span>
<span class="nx">query</span><span class="p">.</span><span class="nx">setOffset</span><span class="p">(</span><span class="mf">100</span><span class="p">);</span>
<span class="nx">queyr</span><span class="p">.</span><span class="nx">setLimit</span><span class="p">(</span><span class="mf">20</span><span class="p">);</span>
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">userList</span> <span class="o">=</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">findPageByQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span>

<span class="c1">// 如果只查询一条记录</span>
<span class="nx">User</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">findFirstByQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span></code></pre></figure> <h2 id="section-1">2. 仅根据等于条件进行查询</h2> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">User</span> <span class="nx">example</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">User</span><span class="p">();</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">setStatus</span><span class="p">(</span><span class="mf">10</span><span class="p">);</span>

<span class="nx">IEntityDao</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">dao</span> <span class="o">=</span> <span class="nx">daoProvider</span><span class="p">.</span><span class="nx">daoFor</span><span class="p">(</span><span class="nx">User</span><span class="p">.</span><span class="kd">class</span><span class="p">);</span>     
<span class="nx">List</span><span class="o">&lt;</span><span class="nx">User</span><span class="o">&gt;</span> <span class="nx">userList</span> <span class="o">=</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">findAllByExample</span><span class="p">(</span><span class="nx">example</span><span class="p">);</span>
<span class="nx">User</span> <span class="nx">user</span> <span class="o">=</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">findFirstbyExample</span><span class="p">(</span><span class="nx">example</span><span class="p">);</span>
<span class="kr">long</span> <span class="nx">count</span> <span class="o">=</span> <span class="nx">dao</span><span class="p">.</span><span class="nx">countByExample</span><span class="p">(</span><span class="nx">example</span><span class="p">);</span></code></pre></figure> <h2 id="section-2">3. 嵌入子查询</h2> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">QueryBean</span> <span class="nx">query</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">QueryBean</span><span class="p">();</span>
<span class="nx">query</span><span class="p">.</span><span class="nx">addFilter</span><span class="p">(</span><span class="nx">SQL</span><span class="p">.</span><span class="nx">begin</span><span class="p">(</span><span class="s2">&quot;o.id in (select y.xx from tbl y where y.id=?&quot;</span><span class="p">,</span> <span class="mf">3</span><span class="p">).</span><span class="nx">end</span><span class="p">().</span><span class="nx">asFilter</span><span class="p">());</span>
<span class="nx">dao</span><span class="p">.</span><span class="nx">findPageByQuery</span><span class="p">(</span><span class="nx">query</span><span class="p">);</span></code></pre></figure> <h2 id="section-3">4. 联表查询</h2> <p>如果按照主表上的字段进行查询，可以直接使用复合属性，在NopORM引擎中，o.product.productType.name这种复合属性会自动根据主外键关联配置生成关联表查询语句</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>QueryBean query = new QueryBean();
query.addFiler(eq(&quot;product.productType.name&quot;,&quot;abc&quot;));
dao.findFirstByQuery(query);</code></pre></figure> <p>如果需要按照子表中的属性查找主表对象，可以使用上一节中介绍的子查询过滤，也可以直接使用EQL查询语言</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>select distinct o.book from BookAuthor o where o.author.name like &#39;张%&#39;</code></pre></figure> <p>以上查询语句根据作者的名称查找他所写过的书, BookAuthor是一个关联表，通过o.author.name实现对author表的关联查询，而通过o.book返回关联的书籍对象。</p> <p>如果不写distinct关键字，则因为是多对多关系，返回的集合中可能会包含重复元素。</p> <h2 id="sql-lib">5. 在sql-lib等标签库中的查询条件</h2> <p>Nop平台非常强调同一种模型信息存在多种表达形式，并且这些形式之间可以自由的转换。作为一个典型用例，Filter提供了一种标准的复杂判断条件表达形式。 它的信息结构由<a href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-xdefs/src/main/resources/_vfs/nop/schema/query/filter.xdef" target="_blank" rel="external nofollow">filter.xdef</a> 元模型来定义。</p> <ol> <li>在Java中我们可以通过FilterBeans类上的and/or/eq/gt等帮助函数来构建TreeBean对象。</li> <li>在XML和Xpl模板语言中，我们可以用<code>&lt;eq name="status" value="1" /&gt;</code>这种XML语法来表达同样的判断条件</li> <li>FilterBeanToSQLTransformer类可以将Filter信息转换为SQL查询语句，例如 <code>o.status = 1</code></li> <li>FilterBeanToPredicateTransformer类可以将Filter信息转换为Java中的Predicate接口，在内存中执行判断</li> </ol> <p>在规则引擎中我们使用的判断条件也是由Filter模型来定义。 <img src="/assets/knosys/project-nop-entropy/dev-guide/rule/images/rule-model-94111a8481dd8d42376dcae328be0f8be705fb94d3468c2c934126c97be29b85.png" alt="rule-model.png" /></p> <p>我们在xpl模板语言中更加自由的使用Filter过滤</p> <ul> <li>在xbiz模型中实现查询函数</li> </ul> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;query</span> <span class="na">name=</span><span class="s">&quot;active_findPage&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;source&gt;</span>
        <span class="nt">&lt;bo:FindPage&gt;</span>
            <span class="nt">&lt;filter&gt;</span>
                <span class="nt">&lt;eq</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
            <span class="nt">&lt;/filter&gt;</span>
        <span class="nt">&lt;/bo:FindPage&gt;</span>
    <span class="nt">&lt;/source&gt;</span>
<span class="nt">&lt;/query&gt;</span></code></pre></figure> <p>bo.xlib中提供了对CrudBizModel中doFindPage等函数的封装</p> <ul> <li>在sql-lib中定义SQL语句 sql-lib提供了类似MyBatis的SQL管理功能，可以通过SqlMapper接口来调用sql-lib中管理的sql语句，也可以直接通过SqlLibManager来调用</li> </ul> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@SqlLibMapper</span><span class="p">(</span><span class="s">&quot;/app/mall/sql/LitemallGoods.sql-lib.xml&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">LitemallGoodsMapper</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="nf">syncCartProduct</span><span class="p">(</span><span class="nd">@Name</span><span class="p">(</span><span class="s">&quot;product&quot;</span><span class="p">)</span> <span class="n">LitemallGoodsProduct</span> <span class="n">product</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure> <p>在LitmallGoods.sql-lib.xml中</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;sql-lib&gt;</span>
    <span class="nt">&lt;sqls&gt;</span>
        <span class="nt">&lt;eql</span> <span class="na">name=</span><span class="s">&quot;syncCartProduct&quot;</span> <span class="na">sqlMethod=</span><span class="s">&quot;execute&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;arg</span> <span class="na">name=</span><span class="s">&quot;product&quot;</span><span class="nt">/&gt;</span>

            <span class="nt">&lt;source&gt;</span>
                update LitemallCart o
                set o.price = ${product.price},
                o.goodsName = ${product.goods.name},
                o.picUrl = ${product.url},
                o.goodsSn = ${product.goods.goodsSn}
                where o.productId = ${product.id}
            <span class="nt">&lt;/source&gt;</span>
        <span class="nt">&lt;/eql&gt;</span>
    <span class="nt">&lt;/sqls&gt;</span>
<span class="nt">&lt;/sql-lib&gt;</span></code></pre></figure> <p>其中eql表示使用EQL对象查询语法，它使用实体名、属性名来访问数据，语法与SQL类似，但是支持复合属性，例如 o.product.type 会自动识别外键关联，并转换为关联查询条件。</p> <p>如果使用sql标签，则表示使用原生SQL语法。也就是说sql-lib中是同时管理SQL查询语句和EQL查询语句。</p> <ul> <li>在数据权限配置中使用 在/nop/main/auth/app.data-auth.xml文件中配置数据权限</li> </ul> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;data-auth&gt;</span>
    <span class="nt">&lt;objs&gt;</span>
        <span class="nt">&lt;obj</span> <span class="na">name=</span><span class="s">&quot;MyEntity&quot;</span><span class="nt">&gt;</span>
            <span class="nt">&lt;role-auths&gt;</span>
                <span class="nt">&lt;role-auth</span> <span class="na">roleId=</span><span class="s">&quot;manager&quot;</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;filter&gt;</span>
                        <span class="nt">&lt;eq</span> <span class="na">name=</span><span class="s">&quot;type&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
                    <span class="nt">&lt;/filter&gt;</span>
                <span class="nt">&lt;/role-auth&gt;</span>
            <span class="nt">&lt;/role-auths&gt;</span>
        <span class="nt">&lt;/obj&gt;</span>
    <span class="nt">&lt;/objs&gt;</span>
<span class="nt">&lt;/data-auth&gt;</span></code></pre></figure> <p>在xpl模板语言中，我们引入自定义标签来简化Filter的编写，例如</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;and&gt;</span>
    <span class="nt">&lt;eq</span> <span class="na">name=</span><span class="s">&quot;status&quot;</span> <span class="na">value=</span><span class="s">&quot;1&quot;</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;app:FilterByTask/&gt;</span>
<span class="nt">&lt;/and&gt;</span></code></pre></figure> <p><code>&lt;app:FilterByTask&gt;</code>是一个自定义标签，它只要能够输出一个符合格式要求的XML节点即可（实际上是XNode类型，它实现了ITreeBean接口）。</p> <p>也可以增加动态判断条件</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>&lt;bo:FindPage&gt;
  &lt;filter&gt;
     &lt;c:if test=&quot;${request.status}&quot;&gt;
        &lt;eq name=&quot;status&quot; value=&quot;${request.status}&quot; /&gt;
     &lt;/c:if&gt;
  &lt;/filter&gt;
&lt;/bo:FindPage&gt;</code></pre></figure> <p>也可以利用元编程机制简化标签编写,例如 <code>&lt;sql:filter&gt;</code>是一个宏标签，它在编译期执行，相当于是对源码结构进行变换</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;sql:filter&gt;</span>and o.classId = :myVar<span class="nt">&lt;/sql:filter&gt;</span></code></pre></figure> <p>等价于手写如下代码</p> <figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span></span><span class="nt">&lt;c:if</span> <span class="na">test=</span><span class="s">&quot;${!_.isEmpty(myVar)}&quot;</span><span class="nt">&gt;</span>
    and o.classId = ${myVar}
<span class="nt">&lt;/c:if&gt;</span></code></pre></figure> <h2 id="singlesession">SingleSession支持</h2> <p>IEntityDao上的方法是调用底层的ormTemplate来实现的，而OrmTemplate采用了类似Spring的模板模式，每个函数都会自动开启session来使用，如果上下文环境中已经有session对象，则自动复用.</p> <p>NopGraphQL引擎执行时已经自动开启了OrmSession，所以一般的业务代码中不需要考虑手动打开session。</p> <p>如果要在GraphQL引擎之外使用ORM，可以在函数上标注 <code>@SingleSession</code>和 <code>@Transactional</code>( 注意使用Nop平台内定义的Transactional)注解， 它们会自动打开OrmSession和事务管理器。</p> <p>如果要手工打开session，可以采用如下方法</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="err">@</span><span class="nx">Inject</span>
<span class="nx">IOrmTemplate</span> <span class="nx">ormTemplate</span><span class="p">;</span>

<span class="nx">ormTemplate</span><span class="p">.</span><span class="nx">runInSession</span><span class="p">(</span><span class="nx">session</span><span class="o">-&gt;</span><span class="p">{</span>
  <span class="p">...</span>
<span class="p">})</span></code></pre></figure> <p>事务管理类似</p> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="err">@</span><span class="nx">Inject</span>
<span class="nx">ITransactionTemplate</span> <span class="nx">transactionTemplate</span><span class="p">;</span>

<span class="nx">transactionTemplate</span><span class="p">.</span><span class="nx">runInTransaction</span><span class="p">(</span><span class="nx">txn</span><span class="o">-&gt;</span><span class="p">{</span>
   <span class="p">...</span>
<span class="p">})</span></code></pre></figure> </div> <footer class="Article-footer col-md-3"> <div class="Widget"> <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/dev-guide/orm/orm-basic.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div> </div> <section class="Widget Widget--toc"> <div class="Widget-header"> <h2 class="Widget-title">目录</h2> </div> <div class="Widget-body"></div> </section> </footer> </article> <footer class="Page-footer Footer"> <div class="container-fluid"> <div class="Footer-description"> <!-- Important links --> <nav class="Footer-navs"> <ul><li><a href="/projects/nop-entropy/docs/"><span>指南</span></a> </li><li><a href="/community/"><span>社区</span></a> </li></ul> </nav> <!-- Copyright --> <div class="Footer-copyright"> <p>&copy; 2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有 </p> </div> </div> </div> </footer> </main> </div> <script>$('table').addClass('table table-bordered')</script> <script type="text/javascript" src="/assets/ksio/vendors/share.min-3155ee636b84a04d036e0f1ba833227d3fd03a4c58a6f2e21c9ceb1c5d0198c7.js"></script><script type="text/javascript" src="/assets/ksio/components-a266f21fe1dfd61bebf40e74872cbf901eb3e201f7d33e9e5d5af9a55f4b24ea.js"></script> <script type="text/javascript" src="/assets/ksio/initializers/time-8d7a529a66ae6cb53c2283d21fd6a12c538b8473dd5bd76458366d09adce7bf6.js"></script><script type="text/javascript" src="/assets/ksio/initializers/lazyload-44b7df8a9282d598284d522e64d6be9ac88d466f3c4a734a514303e99347b2c9.js"></script> </body> </html>
