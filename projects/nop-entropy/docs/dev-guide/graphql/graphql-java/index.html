<!DOCTYPE html> <html lang="zh-CN" dir="ltr"> <head> <meta charset="UTF-8"> <!-- SEO --> <title>面向对象的GraphQL - Nop</title> <meta property="og:title" content="面向对象的GraphQL"> <meta name="description" content="Nop平台以数据模型为基础，自动生成实体定义、SQL表定义、GraphQL类型、前端页面等。以部门表Department为例，缺省情况下我们会生成一个GraphQL类型Department，并为主外键关联生成对应的属性，例如parent和children。如果增加了connection标签，我们还会为关联对象生成分页获取所对应的属性，例如usersConnection通过类似Relay Cursor Connection的方式来分页返回属于指定部门的用户。缺省情况下业务对象会自动继承CrudBizModel，所以它会自动生成GraphQL入口操作."> <meta property="og:description" content="Nop平台以数据模型为基础，自动生成实体定义、SQL表定义、GraphQL类型、前端页面等。以部门表Department为例，缺省情况下我们会生成一个GraphQL类型Department，并为主外键关联生成对应的属性，例如parent和children。如果增加了connection标签，我们还会为关联对象生成分页获取所对应的属性，例如usersConnection通过类似Relay Cursor Connection的方式来分页返回属于指定部门的用户。缺省情况下业务对象会自动继承CrudBizModel，所以它会自动生成GraphQL入口操作."> <meta name="keywords" content="Nop,Nop平台,Nop 平台,Nop Platform,Nop社区,Nop 社区,Nop Community,可逆计算,软件构造理论,低代码,lowcode,low-code,low code,低代码平台,lcdp,软件工程"> <link rel="canonical" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/graphql/graphql-java/"> <meta property="og:url" content="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/graphql/graphql-java/"> <meta property="og:site_name" content="Nop"> <script type="application/ld+json"> { "@context" : "http://schema.org", "@type" : "WebSite", "name" : "Nop", "url" : "https://nop-platform.gitee.io" } </script> <meta property="og:type" content="article"> <meta property="article:published_time" content="2024-04-04T09:51:04+08:00"> <link rel="next" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/graphql/left-join/" title="通过QueryBean实现左连接查询"> <link rel="prev" href="https://nop-platform.gitee.io/projects/nop-entropy/docs/dev-guide/graphql/crud/" title="标准增删改查操作"> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "NewsArticle", "headline": "面向对象的GraphQL", "image": null, "datePublished": "2024-04-04T09:51:04+08:00", "description": "Nop平台以数据模型为基础，自动生成实体定义、SQL表定义、GraphQL类型、前端页面等。以部门表Department为例，缺省情况下我们会生成一个GraphQL类型Department，并为主外键关联生成对应的属性，例如parent和children。如果增加了connection标签，我们还会为关联对象生成分页获取所对应的属性，例如usersConnection通过类似Relay Cursor Connection的方式来分页返回属于指定部门的用户。缺省情况下业务对象会自动继承CrudBizModel，所以它会自动生成GraphQL入口操作." } </script> <script type="application/ld+json"> { "@context": "http://schema.org", "@type": "Organization", "url": "https://nop-platform.gitee.io", "logo": "https://nop-platform.gitee.io/assets/logo-9952a8b58c6582fc86a9608db8113158fb31de7a9db19d4358ac7cb96578d34e.png" } </script> <link rel="author" href="https://nop-platform.gitee.io"> <!-- 页面渲染兼容性 --> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="renderer" content="webkit"> <meta name="viewport" content="width=device-width,initial-scale=1.0"> <meta name="theme-color" content="#0871ab"> <link rel="icon" href="/assets/logo-9952a8b58c6582fc86a9608db8113158fb31de7a9db19d4358ac7cb96578d34e.png"> <!-- 静态资源 --> <link type="text/css" rel="stylesheet" href="/assets/global-f979fafa22c865e727cd15f83cdc43dbc73c1a324d7ad4fe6fa48e275dc4c063.css"> <link type="text/css" rel="stylesheet" href="/assets/ksio/vendors/share-c2e41222f5f34b2de38cb5213fa0e439c11da73b3907b444a32635563ae85ffd.css"> <link type="text/css" rel="stylesheet" href="/assets/local/layouts/doc-c5c0ab8b12485893472e680b5f067b74e240481232265b6cb0ab6edc95c20f65.css"> <script type="text/javascript" src="/assets/global-b3a80dd53acf48ad7228d6fd741dba15d3845cbc3783bdbbf7244151a45628aa.js"></script> <!--[if lt IE 9]> <script type="text/javascript" src="/assets/ksio/support_ie8-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.js"></script> <![endif]--> </head> <body class="Page" itemscope itemtype="http://schema.org/WebPage"> <header class="Page-header"> <div class="navbar navbar-static-top"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" type="button" data-target=".Page-navs" data-toggle="collapse"> <span class="sr-only">Toggle navs</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">Nop</a> </div> <!-- Nav menus --> <nav class="Page-navs navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">学习 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/nop-entropy/docs/">指南</a> </li> <li><a href="https://www.zhihu.com/column/reversible-computation?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">文章</a> </li> <li><a href="https://space.bilibili.com/3493261219990250?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">视频</a> </li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">项目 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/projects/nop-entropy/">Nop Entropy</a> </li> <li><a href="/projects/nop-chaos/">Nop Chaos</a> </li> </ul> </li> <li class="dropdown"> <a class="dropdown-toggle" href="javascript:void(0);" data-toggle="dropdown">关于 <span class="caret"></span></a> <ul class="dropdown-menu"> <li><a href="/community/">社区</a> </li> <li><a href="/team/">团队</a> </li> <li><a href="https://gitee.com/nop-platform?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">Gitee 组织</a> </li> </ul> </li> <li><a href="https://nop-platform.github.io?utm_source=https://nop-platform.gitee.io&utm_medium=common-header" target="_blank" rel="external nofollow">English</a> </li> </ul> </nav> </div> </div> </header> <div class="Page-content"> <aside class="Page-aside"> <div class="AsideBrand"> <a href="/">Nop</a> </div> <nav class="AsideNav"><ul> <li> <a href="/projects/nop-entropy/docs/">概览</a> </li> <li> <a href="/projects/nop-entropy/docs/core-code-guidance/">Nop平台核心代码阅读导引</a> </li> <li> <a href="/projects/nop-entropy/docs/why-nop/">Nop平台的定位和发展规划</a> </li> <li> <span>arch</span> <ul> <li> <a href="/projects/nop-entropy/docs/arch/">架构</a> </li> <li> <a href="/projects/nop-entropy/docs/arch/module-dependency/">模块依赖关系</a> </li> </ul> </li> <li> <span>compare</span> <ul> <li> <a href="/projects/nop-entropy/docs/compare/nop-vs-skyve/">从可逆计算看开源低代码平台Skyve的设计</a> </li> <li> <a href="/projects/nop-entropy/docs/compare/nop-vs-springcloud/">Nop平台与SpringCloud的功能对比</a> </li> </ul> </li> <li> <span>dev-guide</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/">开发指南</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/autotest/">自动测试</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/cli/">NopCli命令行工具</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/codegen/">Maven集成代码生成器</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/config/">配置规范</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/customization/">Delta定制</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/debug/">开发调试</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/delta-loader/">[虚拟文件系统](vfs/vfs.md)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/dict/">字典表翻译</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/error-code/">统一响应格式</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/i18n/">dev-guide/i18n.md</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/intro/">dev-guide/intro.md</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/ioc/">3.1 XDef元模型定义</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/quarkus/">日志配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/spring/">Spring集成</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/tenant/">租户配置</a> </li> <li> <span>dev-guide/auth</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/auth/">权限</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/impersonate/">替代登录</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/login/">登录逻辑</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/service-auth/">服务鉴权</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/auth/sso/">启用SSO支持</a> </li> </ul> </li> <li> <span>dev-guide/batch</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/batch/batch-design/">SpringBatch存在的设计问题</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/batch/batch-gen/">dev-guide/batch/batch-gen.md</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/batch/batch-task/">dev-guide/batch/batch-task.md</a> </li> </ul> </li> <li> <span>dev-guide/biz</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/biz/coderule/">编码规则</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/biz/validate/">CrudBizModel中的自动验证</a> </li> </ul> </li> <li> <span>dev-guide/command</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/command/command/">命令行程序支持</a> </li> </ul> </li> <li> <span>dev-guide/delta</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/delta/delta-customization/">如何在不修改基础产品源码的情况下实现定制化开发</a> </li> </ul> </li> <li> <span>dev-guide/graphql</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/connection/">connection配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/crud/">标准增删改查操作</a> </li> <li> <a class="is-selected" href="/projects/nop-entropy/docs/dev-guide/graphql/graphql-java/">面向对象的GraphQL</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/left-join/">通过QueryBean实现左连接查询</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/rest/">REST链接</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/upload/">GraphQL引擎的上传下载扩展</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/graphql/xbiz/">Biz模型</a> </li> </ul> </li> <li> <span>dev-guide/ide</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/ide/idea/">安装JDK</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/ide/plugin-dev/">关联Gradle工程</a> </li> </ul> </li> <li> <span>dev-guide/ioc</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/ioc/aop/">编译期代码生成</a> </li> </ul> </li> <li> <span>dev-guide/job</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/job/job-design/">分布式任务调度</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/job/job/">dev-guide/job/job.md</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/job/trigger/">dev-guide/job/trigger.md</a> </li> </ul> </li> <li> <span>dev-guide/microservice</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/feign/">Feign集成</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/grpc/">NopGraphQL对外暴露为Grpc</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/rpc-design/">低代码平台中的分布式RPC框架(约3000行代码)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/rpc/">一. 服务端配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/microservice/web-filter/">配置项</a> </li> </ul> </li> <li> <span>dev-guide/model</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/">Excel模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/api-model/">Api模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/core-models/">核心模型说明</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/custom-model/">自定义模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/excel-model/">Excel数据模型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/model/excel-xlsx/">1. 解析Excel文件得到Workbook对象</a> </li> </ul> </li> <li> <span>dev-guide/nocode</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/nocode/">在线配置数据模型和服务模型: [dyn-model.md](dyn-model.md)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/nocode/dyn-model/">在线动态建模</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/nocode/dynamic-orm/">内置工作流支持的动态实体</a> </li> </ul> </li> <li> <span>dev-guide/orm</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/">[数据库方言](dialect.md)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/dao-lib/">在标签库中直接执行SQL语句</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/dao/">基本约定</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/data-change-log/">实体修改状态跟踪</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/dialect/">Dialect的继承和定制</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/dql/">dev-guide/orm/dql.md</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/eql/">EQL对象查询语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/ext-field/">如何在不改表的情况下为实体增加扩展字段</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/field-masking/">字段掩码</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/many-to-many/">多对多关联</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/multi-datasource/">多数据源配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/multi-db/">多数据源配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/null-value/">空值的处理</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/orm-basic/">基本使用方式</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/orm/">执行原理</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/session-cache/">一级缓存</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/sql-lib/">1 统一管理SQL/EQL/DQL</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/tcc/">分布式事务</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/to-one-relation/">多对一或者一对一关联</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/orm/transaction/">事务模板</a> </li> </ul> </li> <li> <span>dev-guide/recipe</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/">1. [在后台增加字段](add-field.md)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/add-field/">在后台Graph中增加字段</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/crud/">1. 传递一些实体上没有的字段到后台</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/filter-list/">1. 表格过滤</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/json-helper/">JSON处理</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/tree-entity/">1. 如何取出当前节点的所有兄弟节点，以及所有父节点</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/recipe/xml-helper/">1. 解析XML文本</a> </li> </ul> </li> <li> <span>dev-guide/report</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/">[Excel报表](xpt-report.md)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/excel-formula/">报表导出时支持Excel公式</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/excel-import/">Excel数据导入导出</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/report-design/">非线性中国式报表引擎NopReport源码解析</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/spl/">润乾集算器(SPL)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/word-template-details/">超链接</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/word-template/">1. 为模板中需要被替换的文字增加超链接</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/xpt-report/">报表引擎</a> </li> <li> <span>dev-guide/report/examples</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/examples/base/">基础报表示例</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/examples/dynamic-col/">动态展开列</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/report/examples/form-printing/">套打</a> </li> </ul> </li> </ul> </li> <li> <span>dev-guide/rule</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/rule/rule/">采用Excel作为可视化设计器的规则引擎 NopRule</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/rule/validator/">验证模型</a> </li> </ul> </li> <li> <span>dev-guide/security</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/security/security-design/">Nop平台这么灵活，是不是很容易出现安全性问题？</a> </li> </ul> </li> <li> <span>dev-guide/sonar</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/sonar/sonarqube/">配置</a> </li> </ul> </li> <li> <span>dev-guide/spring</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/spring/spring-delta/">如何为Spring和Mybatis增加可逆计算支持</a> </li> </ul> </li> <li> <span>dev-guide/vfs</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/vfs/model-loader/">DSL模型文件加载</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/vfs/std-resource-path/">标准资源路径模式</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/vfs/vfs/">虚拟文件系统</a> </li> </ul> </li> <li> <span>dev-guide/workflow</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/flow-builder/">类钉钉工作流</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/graph-designer/">通用流程设计器</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-flow/">逻辑编排</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/task-queue/">任务队列</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/workflow/task/">堆栈式任务流</a> </li> </ul> </li> <li> <span>dev-guide/xlang</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/">XLang</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/antlr/">AST映射约定</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/feature-expr/">特性开关</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/meta-programming/">低代码平台中的元编程(Meta Programming)</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/x-override/">可逆计算理论中的Delta合并算法</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdef/">XDef元模型定义语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xdsl/">XDSL：通用的领域特定语言设计</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xjson/">使用XML格式来表达json对象</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xlang-demo/">XLang综合示例</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xlang/">简要说明</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xmeta/">元数据</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpath/">dev-guide/xlang/xpath.md</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xpl/">说明</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xscript/">XScript</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xlang/xtransform/">dev-guide/xlang/xtransform.md</a> </li> </ul> </li> <li> <span>dev-guide/xui</span> <ul> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/">XUI</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/adapter/">适配</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/amis/">AMIS框架扩展</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/javascript/">XScript与JavaScript的兼容性</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/layout/">布局语言</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/sdk/">通过nop-sdk实现前端集成</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/typescript/">提取实体类型的部分字段类型</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/web-xlib/">web.xlib</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/xpage/">前端配置</a> </li> <li> <a href="/projects/nop-entropy/docs/dev-guide/xui/xview/">XView视图模型</a> </li> </ul> </li> </ul> </li> <li> <span>faq</span> <ul> <li> <a href="/projects/nop-entropy/docs/faq/debug-errors/">调试错误</a> </li> <li> <a href="/projects/nop-entropy/docs/faq/faq/">常见问题</a> </li> </ul> </li> <li> <span>frontend</span> <ul> <li> <a href="/projects/nop-entropy/docs/frontend/frontend-design/">前端架构设计</a> </li> <li> <a href="/projects/nop-entropy/docs/frontend/nop-site/">界面框架</a> </li> <li> <a href="/projects/nop-entropy/docs/frontend/react/">React</a> </li> <li> <a href="/projects/nop-entropy/docs/frontend/vite/">Vite</a> </li> </ul> </li> <li> <span>gpt</span> <ul> <li> <a href="/projects/nop-entropy/docs/gpt/copilot-prompts/">gpt/copilot-prompts.md</a> </li> <li> <a href="/projects/nop-entropy/docs/gpt/create-module/">gpt/create-module.md</a> </li> <li> <a href="/projects/nop-entropy/docs/gpt/create-workflow/">gpt/create-workflow.md</a> </li> <li> <a href="/projects/nop-entropy/docs/gpt/read-doc/">gpt/read-doc.md</a> </li> <li> <a href="/projects/nop-entropy/docs/gpt/update-table/">gpt/update-table.md</a> </li> <li> <span>gpt/alpha-codium</span> <ul> <li> <a href="/projects/nop-entropy/docs/gpt/alpha-codium/READM/">gpt/alpha-codium/READM.md</a> </li> </ul> </li> <li> <span>gpt/gpt-pilot</span> <ul> <li> <a href="/projects/nop-entropy/docs/gpt/gpt-pilot/READM/">gpt/gpt-pilot/READM.md</a> </li> </ul> </li> <li> <span>gpt/reference</span> <ul> <li> <a href="/projects/nop-entropy/docs/gpt/reference/tutor/">gpt/reference/tutor.md</a> </li> </ul> </li> </ul> </li> <li> <span>intro</span> <ul> <li> <a href="/projects/nop-entropy/docs/intro/intro/">介绍</a> </li> </ul> </li> <li> <span>performance</span> <ul> <li> <a href="/projects/nop-entropy/docs/performance/optimize-theory/">性能优化方法论</a> </li> <li> <a href="/projects/nop-entropy/docs/performance/optimize-tool/">性能优化工具</a> </li> </ul> </li> <li> <span>theory</span> <ul> <li> <a href="/projects/nop-entropy/docs/theory/">知乎专栏: [可逆计算](https://www.zhihu.com/column/reversible-computation)</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/advantage-of-lowcode/">低代码开发的优势体现在哪里？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/ddd-in-nop/">万字长文讲清DDD在低代码平台中的最佳实践</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/declarative-programming/">从可逆计算看声明式编程</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/decouple/">解耦远不止依赖注入</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/delta-oriented-programming/">从可逆计算看Delta Oriented Programming</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/design-methodology/">一. 树形结构：长程关联</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/discussion-about-reversible-computation/">关于可逆计算的讨论--答圆角骑士魔理沙</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/discusson-about-nop/">关于Nop平台以及低代码平台建设经验的讨论</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/essence-of-react/">从React Hooks看React的本质</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/framework-agnostic/">业务开发如何才能独立于框架</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/generic-delta-composition/">通用的Delta差量化机制</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/good_design/">theory/good_design.md</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/graphql-vs-rest/">为什么在数学的意义上GraphQL严格的优于REST？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/lowcode-expained/">1. 代码生成器是低码吗？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/lowcode-ioc/">如果重写SpringBoot，我们会做哪些不同的选择？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/lowcode-orm-1/">低代码平台需要什么样的ORM引擎？(1)</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/lowcode-orm-2/">低代码平台需要什么样的ORM引擎?(2)</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/lowcode-task-flow/">从零开始编写的下一代逻辑编排引擎</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/methodology-of-reversible-computation/">可逆计算理论</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/nop-for-gpt/">GPT用于复杂代码生产所需要满足的必要条件</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/paxos/">Paxos的魔法学研究报告</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/pros-and-cons-of-framework/">如何评价一种框架技术的好坏？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/reuse/">从可逆计算看AI时代的复用</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/reversible-computation-and-lowcode/">从可逆计算看低代码</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/reversible-computation-for-programmers/">写给程序员的可逆计算理论辨析</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/reversible-computation-for-programmers2/">写给程序员的可逆计算理论辨析补遗</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/reversible-computation/">可逆计算：下一代软件构造理论</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/technical-strategy/">Nop平台为什么是一个独一无二的开源软件开发平台</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/tensor-product-lowcode/">从张量积看低代码平台的设计</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/what-does-reversible-mean/">可逆计算理论中的可逆到底指的是什么？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/what-is-data-driven/">什么是数据驱动？它和模型驱动、领域驱动、元数据驱动、DSL驱动之间有什么区别？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/why-nop-report-is-special/">NopReport为什么是一个非常独特的报表引擎？</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/why-xml/">为什么Nop平台坚持使用XML而不是JSON或者YAML</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/xdsl-design/">从可逆计算看DSL的设计要点</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/xml-json-equivalence/">XML、JSON和函数AST的等价性</a> </li> <li> <span>theory/amis</span> <ul> <li> <a href="/projects/nop-entropy/docs/theory/amis/amis-and-declarative-programming/">再谈百度AMIS框架和声明式编程</a> </li> <li> <a href="/projects/nop-entropy/docs/theory/amis/why-amis-is-good/">为什么说百度AMIS框架是一个优秀的设计</a> </li> </ul> </li> </ul> </li> <li> <span>tutorial</span> <ul> <li> <a href="/projects/nop-entropy/docs/tutorial/tutorial/">开发示例</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/tutorial_en/">Development Tutorial</a> </li> <li> <span>tutorial/simple</span> <ul> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/1-simple-service/">Nop入门：极简服务层开发</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/2-simple-dao/">Nop入门：极简数据访问层开发</a> </li> <li> <a href="/projects/nop-entropy/docs/tutorial/simple/3-simple-page/">极简前端页面开发</a> </li> </ul> </li> </ul> </li> <li> <span>user-guide</span> <ul> <li> <a href="/projects/nop-entropy/docs/user-guide/">用户指南</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/batch/">user-guide/batch.md</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/report/">采用Excel作为设计器的开源中国式报表引擎：NopReport</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/rule/">user-guide/rule.md</a> </li> <li> <a href="/projects/nop-entropy/docs/user-guide/workflow/">user-guide/workflow.md</a> </li> <li> <span>user-guide/idea</span> <ul> <li> <a href="/projects/nop-entropy/docs/user-guide/idea/idea-plugin/">XLang DSL Plugin</a> </li> </ul> </li> <li> <span>user-guide/monitor</span> <ul> <li> <a href="/projects/nop-entropy/docs/user-guide/monitor/grafana/">运行时监控</a> </li> </ul> </li> </ul> </li> </ul> </nav> </aside> <main class="Page-main"> <article class="Article container-fluid"> <header class="Article-header"> <h1 class="Article-title">面向对象的GraphQL</h1> </header> <div class="Article-content col-md-9"><p>Nop平台以数据模型为基础，自动生成实体定义、SQL表定义、GraphQL类型、前端页面等。以部门表Department为例，缺省情况下我们会生成一个GraphQL类型Department， 并为主外键关联生成对应的属性，例如parent和children。如果增加了connection标签，我们还会为关联对象生成分页获取所对应的属性， 例如usersConnection通过类似<a href="https://relay.dev/graphql/connections.htm" target="_blank" rel="external nofollow">Relay Cursor Connection</a>的方式来分页返回属于指定部门的用户。 缺省情况下业务对象会自动继承CrudBizModel，所以它会自动生成GraphQL入口操作.</p> <blockquote> <p>关于connection的具体介绍，参见<a href="../connection/">connection.md</a></p> </blockquote> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>extend type Query{
    Department__get(id:String!): Department
    Department__batchGet(ids:[String!]): [Department]
    Department__findPage(query:QueryBeanInput): PageBean_Department
    ...
} 
extend type Mutation{
    Department__save(data: DepartmentInput): Department
    Department__delete(id:String!): Boolean
    ...
}</code></pre></figure> <p>Nop平台内置了一个自动化的后台管理软件生产线，它的输入是用户需求（以Excel文档的形式表达），输出是可运行的应用系统，主要通过系统化的增量式代码生成方案来实现生产线的运转。这其中，GraphQL Schema是根据Meta元数据定义和BizModel业务模型定义自动生成的一种中间产物，我们并不会手工编写GraphQL类型定义，在编写业务代码的过程中也不需要具有任何GraphQL相关的知识，不需要实现GraphQL特有的DataFetcher、DataLoader等接口。具体的技术细节在“差量流水线”一节中会有更详细的介绍。另外可以参考以下文章：</p> <p><a href="https://zhuanlan.zhihu.com/p/540022264" target="_blank" rel="external nofollow">数据驱动的差量化代码生成器</a></p> <h2 id="graphql">GraphQL对象定义</h2> <p>NopGraphQL引擎在初始化的时候会利用IoC容器的动态扫描能力发现所有标记了<code>@BizModel</code>注解的bean，并把它们按照BizObjName配置进行归类合并。例如</p> <figure class="highlight"><pre><code class="language-java" data-lang="java"><span></span><span class="nd">@BizModel</span><span class="p">(</span><span class="s">&quot;NopAuthUser&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NopAuthUserBizModel</span> <span class="kd">extends</span> <span class="n">CrudBizModel</span><span class="o">&lt;</span><span class="n">NopAuthUser</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nd">@BizMutation</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">changeSelfPassword</span><span class="p">(</span><span class="nd">@Name</span><span class="p">(</span><span class="s">&quot;oldPassword&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">oldPassword</span><span class="p">,</span>
                                   <span class="nd">@Name</span><span class="p">(</span><span class="s">&quot;newPassword&quot;</span><span class="p">)</span> <span class="n">String</span> <span class="n">newPassword</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="nd">@BizModel</span><span class="p">(</span><span class="s">&quot;NopAuthUser&quot;</span><span class="p">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">NopAuthUserBizModelEx</span> <span class="p">{</span>
    <span class="nd">@BizMutation</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">otherOperation</span><span class="p">()</span> <span class="p">{</span>
         <span class="p">...</span>
    <span class="p">}</span>

    <span class="nd">@BizMutation</span>
    <span class="nd">@Priority</span><span class="p">(</span><span class="n">NORMAL_PRIORITY</span> <span class="o">-</span> <span class="mi">100</span><span class="p">)</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">changeSelfPassword</span>
    <span class="nd">@Name</span><span class="p">(</span><span class="s">&quot;oldPassword&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">oldPassword</span><span class="p">,</span>
    <span class="nd">@Name</span><span class="p">(</span><span class="s">&quot;newPassword&quot;</span><span class="p">)</span>
    <span class="n">String</span> <span class="n">newPassword</span><span class="p">)</span>

    <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure> <p>NopAuthUserBizModel和NopAuthUserBizModelEx的BizObjectName都是NopAuthUser，它们的方法会叠加在一起共同生成NopAuthUser业务对象上的方法。当出现同名的函数时，会按照<code>@Priority</code> 优先级配置选择优先级更高的实现。如果优先级相同且函数名相同，则会抛出异常。</p> <p>NopGraphQL引擎在构造BizObject的时候还会检查xbiz扩展模型，我们可以通过在NopAuthUser.xbiz模型文件中增加方法来扩展BizObject，这个模型文件可以在线更新，更新后会即时起效，无需重新初始化GraphQL类型定义。xbiz文件中定义的方法优先级最高，它会自动覆盖JavaBean中定义的业务方法。</p> <p>如果把对象名相同的BizModel看作是对象的一个切片，则NopGraphQL引擎相当于是在系统初始化的时候动态收集这些对象切片，然后像docker镜像一样把它们叠加在一起，构成完整的对象定义。在运行时，最上层的xbiz切片可以被动态修改，并覆盖下层切片的功能。</p> <blockquote> <p>BizModel切片的概念有些类似于游戏开发领域中的Entity Component System (ECS)模式，只是它累加的是动态行为而不是局部状态。</p> </blockquote> <p>与Gather对偶的能力是Scatter：我们经常需要做一些全局规则的抽象，需要将某些公共知识自动推送到不同的业务对象中。NopGraphQL主要通过AOP机制和元编程机制来实现信息的分发：</p> <ol> <li> <p>公共的机制可以作为AOP拦截器作用于符合条件的业务方法上</p> </li> <li> <p>xbiz文件中可以通过XLang中通用的x:gen-extends元编程机制动态生成方法定义。也可以使用外部的CodeGenerator来生成代码。</p> </li> </ol> <h2 id="crud">CRUD模型</h2> <p>在一般的业务开发中，CRUD(Create/Read/Update/Delete) 操作往往是不同的业务对象中相似度最高的部分，因此有必要对它们进行统一抽象。NopGraphQL使用设计模式中的模板方法(Template Method)模式提供了通用的CRUD实现：CrudBizModel。具体使用方法是从CrudBizModel类继承，然后可以通过实现defaultPrepareSave/afterEntityChange等函数补充定制逻辑。参见代码</p> <p><a href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-biz/src/main/java/io/nop/biz/crud/CrudBizModel.java" target="_blank" rel="external nofollow">CrudBizModel.java</a></p> <p><a href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-biz/src/main/java/io/nop/biz/crud/ObjMetaBasedValidator.java" target="_blank" rel="external nofollow">ObjMetaBasedValidator.java</a></p> <p><a href="https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-auth/nop-auth-service/src/main/java/io/nop/auth/service/entity/NopAuthUserBizModel.java" target="_blank" rel="external nofollow">NopAuthUserBizModel.java</a></p> <h2 id="section">3.1 元数据驱动</h2> <p>CrudBizModel采用的是元数据驱动的实现方式，它会读取xmeta配置文件中的内容，内置实现了数据验证、自动初始化、级联删除、逻辑删除、数据权限等多种常见需求，所以一般情况下只需要调整xmeta和xbiz配置文件，并不需要编写定制逻辑。</p> <ol> <li>数据验证：类似于GraphQL的输出选择，NopGraphQL可以对输入字段进行选择性验证和转换，这体现了<strong>输入和输出的对偶性</strong>。</li> </ol> <figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span></span><span class="nx">validatedData</span> <span class="o">=</span> <span class="ow">new</span> <span class="nx">ObjMetaBasedValidator</span><span class="p">(</span><span class="nx">bizObjManager</span><span class="p">,</span><span class="nx">bizObjName</span><span class="p">,</span><span class="nx">objMeta</span><span class="p">,</span><span class="nx">context</span><span class="p">,</span><span class="nx">checkWriteAuth</span><span class="p">)</span>
                       <span class="p">.</span><span class="nx">validateForSave</span><span class="p">(</span><span class="nx">input</span><span class="p">,</span><span class="nx">inputSelection</span><span class="p">)</span>
   <span class="sb">```</span>

<span class="sb">2. 自动初始化：在meta中可以配置字段的autoExpr表达式，更新或者修改的时候可以根据该配置自动初始化字段值。autoExpr表达式可以根据数据模型中的domain配置自动生成。</span>

<span class="sb">3. 自动转换：根据meta中配置transformIn表达式，对输入的属性值进行适配转换。transformIn表达式可以根据数据模型中的domain配置自动生成。</span>

<span class="sb">4. 级联删除：标记为cascade-delete的子表数据会随着主表数据的删除一并删除，而且会执行子表对应的BizObject业务对象上的定义的删除逻辑。</span>

<span class="sb">5. </span>

<span class="sb">逻辑删除：如果启用delFlag逻辑删除标记字段，则底层的ORM引擎会自动将删除调用转换为修改delFlag的操作，并且对所有查询都自动应用delFlag=0的过滤条件，除非明确在SQL对象上设置disableLogicalDelete属性。</span>

<span class="sb">6. 数据权限：所有读取到的实体记录都会自动验证是否满足数据权限要求。</span>

<span class="sb">## 3.2 复杂查询</span>

<span class="sb">CrudBizModel对于复杂查询提供了三个标准接口</span></code></pre></figure> <p>javascript PageBean<ormentity> findPage(@Name("query") QueryBean query, FieldSelectionBean selection); List<ormentity> findList(@Name("query") QueryBean query); OrmEntity findFirst(@Name("query") QueryBean query);</ormentity></ormentity></p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>1. findPage会根据查询条件返回分页查询结果，分页逻辑可以采用cursor+next
   page的方式，也可以采用传统的offset+limit的方式。selection对应于前端调用时传入的返回字段集合。\*
   \*如果没有要求返回total总页数，则findPage内部会跳过总页数查询，如果没有要求返回items数据列表，则实际会调整真正的分页查询本身
   \*\*。

2. findList根据查询条件返回列表数据，如果没有设置分页大小，则按照meta上的配置选择maxPageSize条记录。

3. findFirst返回满足条件的第一条记录。

QueryBean类似于Hibernate中的Criteria查询对象，支持复杂的and/or嵌套查询条件以及排序条件。QueryBean可以由前台直接构造，在送到dao中真正执行之前它会经历如下处理过程：

1. 验证查询条件中只包含`queryable=true`的字段，且查询算符在每个字段的allowFilterOp集合中，缺省只允许按照相等条件进行查询。例如配置用户名支持模糊查询
   
   ```xml
   &lt;!-- 支持按照相等或者模糊匹配的方式进行查询，缺省前端生成的控件为模糊查询 --&gt;
   &lt;prop name=&quot;userName&quot; allowFilterOp=&quot;eq,contains&quot; queryable=&quot;true&quot; 
             xui:defaultFilterOp=&quot;contains&quot;/&gt;  
   ```

2. 追加数据权限过滤条件，例如过滤只能查看管理单位是本单位的数据。

3. 增加按主键字段排序的排序条件。分页查询时如果不进行排序，则因为数据库并发执行的原因，返回的结果集合可能是随机的。所以所有分页查询原则上都应该具有排序条件，确保排序后的分页顺序一致。

QueryBean利用底层的NopOrm引擎的能力，可以很自然的支持关联对象查询，例如</code></pre></figure> <p>xml</p> <eq name="manager.dept.type" value="1" /> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>表示按照 manager.dept.type = 1条件进行过滤，自动根据`manager_id`关联对应的部门表。

如果底层的ORM引擎不支持关联查询，也可以自行编写一个QueryTransformer接口来对QueryBean进行变换，例如将上面的等于判断转换为一个子查询</code></pre></figure> <p>sql o.manager_id in (select user.id from User user, Dept dept where user.dept_id = dept.id and dept.type = 1)</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>在前端，为了通过以表单方式构造复杂查询条件，我们在AMIS框架中做了如下约定：</code></pre></figure> <p>字段名格式为: filter_{propName}__{filterOp}</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>例如 `filter_userName__contains`表示按照contains运算符对userName字段进行过滤。对于filterOp为eq(等于条件)
的情况，可以省略filterOp的部分，例如 filter\_userId等价于`filter_userId__eq`

注意：过滤条件的值如果为空，则会忽略该字段条件。如果一定要按照空值进行查询，则可以使用`__null`来表示null,使用`__empty`
来表示空字符串。

在AMIS的url中调用以findPage/findList/findFirst为后缀的方法时，可以使用filter过滤约定</code></pre></figure> <p>javascript { url: “@query:NopAuthUser__findPage?filter_userStatus=1” }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>### 复杂查询条件的构造

直接调用后台的GraphQL服务或者REST服务时，可以构造QueryBean对象。</code></pre></figure> <p>POST /r/NopAuthUser__findPage</p> <p>{ “query”: { “filter”: { “$type”: “eq”, “name” : “userStatus”, “value”: 1 } } }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>filter对应于后台的TreeBean类型的对象，这是一个通用的Tree结构，并且可以自动转换为XML格式。具体转换规则是Nop平台所定义的一种标准转换机制：

1. $type属性对应于标签名
2. $body对应于子节点和节点内容
3. 不以$为前缀的其他属性对应于XML节点的属性
4. 以`@:`为前缀的值按照json格式解析</code></pre></figure> <p>xml</p> <and> <eq name="status" value="@:1" /> <gt name="amount" value="@:3" /> </and> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>对应于</code></pre></figure> <p>json { “$type”: “and”, “$body”: [ { “$type”: “eq”, “name”: “status”, “value”: 1 }, { “$type”: “gt”, “name”: “amount”, “value”: 3 } ] }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>过滤条件中所支持的运算符如eq,gt等，都是[FilterOp.java](https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-core/src/main/java/io/nop/core/model/query/FilterOp.java){:target=&quot;_blank&quot;}{:rel=&quot;external nofollow&quot;}
中定义的操作符。
重用的算符有：

|操作符|说明|
|---|---|
|eq|等于|
|gt|大于|
|ge|大于等于|
|lt|小于|
|xe|小于等于|
|in|在集合中|
|between|介于min和max之间|
|betweenDate|日期在min和max之间|
|alwaysTrue|总是为真|
|alwaysFalse|总是为假|
|isEmpty|name对应的值为空|
|startsWith|字符串的前缀为指定值|
|endsWith|字符串的后缀为指定值|

## 3.3 this指针：知识的相对化

GraphQL中定义的操作名是全局名称，例如 `query{ getUser(id:3){ id, userName}}`
查询中用到的getUser方法需要在整个模型中具有唯一性，这一要求对于复用代码来说是不利的。

NopGraphQL中实现CRUD时只需要继承CrudBizModel基类，对外暴露的GraphQL操作名由对象名和方法名拼接而成。</code></pre></figure> <p>java class CrudBizModel<t> { @BizQuery @GraphQLReturn(bizObjName = "THIS_OBJ") public T get(@Name("id") String id) { .... } }</t></p> <p>@BizModel(“NopAuthUser”) class NopAuthUserBizModel extends CrudBizModel<nopauthuser> {</nopauthuser></p> <p>}</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>上面的示例中，NopGraphQL引擎会自动生成一个query操作`NopAuthUser_get`，并且它的返回类型为`THIS_OBJ`
，这意味着它会被替换为当前对象所对应的BizObjName，即NopAuthUser。

注意到，采用这种实现方案，我们可以针对同一个实现类提供不同的GraphQL类型。例如</code></pre></figure> <p>java @BizModel(“NopAuthUser_admin”) public NopAuthUserAdminBizModel extends CrudBizModel<nopauthuser>{</nopauthuser></p><pre><code>    }
</code></pre><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>同样是从`CrudBizModel&lt;NopAuthUser&gt;`继承，但是因为BizModel注解中提供的bizObjName为`NopAuthUser_admin`
，则get方法返回的字段集合可以有别于普通的NopAuthUser，对后台调用的权限要求也可能不一样。

也就是说，对象上的方法名是一个局部名称，它的语义是相对于this指针而定义的。在不具备全部知识的情况下，我们可以基于相对知识编制相当复杂的逻辑，然后注入不同的this指针，就可以改变整个一组调用的具体含义。这实际上是面向对象最基本的设计原理。

&gt; 面向对象技术创造了一个特殊的名---this指针，它是一种约定了的固化了的局部名称。使用this指针使得我们区分了领域(domain)
&gt; 的内外。在domain外对象可以有各种称谓，而domain内我们直接通过this直接指代当前对象。
&gt; 
&gt; 代码本身只是一种形式表达，它的具体含义需要一个诠释的过程才能确定。基于对象指针的调用形式直接导向了诠释的多样化：只要注入不同的this指针，就可以提供不同的诠释。

在前台的实现中，我们使用了类似的策略：前台脚本根据方法名的后缀自动判断方法签名，例如所有以`_findPage`为后缀的方法它的缺省签名都是</code></pre></figure> <p>java XXX_findPage(query:QueryBeanInput):PageBean_XXX</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>### 返回值类型

BizModel上的服务方法不需要将返回值类型包装为ApiResponse，框架自身会负责进行ApiResponse包装。而且如果返回String类型，那么对应到前台就是String，不会自动解析为JSON。
如果返回Map或者其他bean对象，则会按照DataLoader机制进行属性加载然后返回。如果返回的是CompletionStage，则表示异步执行。</code></pre></figure> <p>@BizQuery public Map&lt;String,Object&gt; myMethod(){ … }</p> <p>@BizQuery public CompletionStage&lt;Map&lt;String,Object» myMethod2Async(){ return … }</p> <p>@BizQuery public MyResultBean myMethod3(){ return … }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>## 四. 框架无关的设计

使用传统的Web框架在编写业务代码的时候总是不可避免的会用到框架特有的一些环境对象，例如HttpServletRequest或者SpringMVC中的ModelAndView等。这些对象都和框架特定的运行时环境强相关，使得我们的代码与某个运行时环境绑定，难以应用到多种使用场景中。最明显的，一个为在线API调用编制的服务函数，一般无法直接作为消息队列的消费者来使用。我们必须抽象出一个额外的层次:
Service层，然后在Service层的基础上分别包装为Controller和MessageConsumer，让它们负责响应Web请求和消息队列。

NopGraphQL在实现业务方法时，采用的是一种框架无关的非侵入式设计，它扩展了服务方法的使用场景，简化了服务层的编写。具体来说，NopGraphQL引入了少量注解，使用POJO对象来作为输入输出对象，自动将业务方法翻译为GraphQL引擎所需的DataFetcher和DataLoader。例如</code></pre></figure> <p>java</p> <p>@BizModel(“MyEntity”) class MyBizModel { @BizQuery public MyEntity get(@Name(“id”) String id) { return … }</p><pre><code>@BizLoader
public String extProp(@ContextSource MyEntity entity) {
    ...
}

@BizLoader(forType = OtherEntity.class)
public String otherProp(@ContextSource OtherEntity entity) {
   ...
}

@BizLoader("someProp")
public CompletionStage&lt;List&lt;SomeObject&gt;&gt; batchLoadSomePropAsync(
        @ContextSource List&lt;MyEntity&gt; entities) {
   ...
} }
</code></pre><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>1. `@BizQuery`表示本方法将被映射为GraphQL中的query调用，`@BizMutation`将被映射为GraphQL中的mutation调用。

2. `@BizLoader`为GraphQL类型的属性提供fetcher和loader定义。注意，为了保证概念的简单性，NopGraphQL要求所有属性都必须在xmeta文件中声明，BizModel中仅是为已定义的属性提供定制的加载器。

3. 如果返回值类型为CompletionStage，则表示该方法异步执行

4. 如果标注了`@BizLoader`注解的方法的ContextSource参数为 List类型，则表示它对应GraphQL的DataLoader实现，支持批量加载。

![]({{ &#39;knosys/project-nop-entropy/arch/BizModel&#39; | asset_path }})

基于NopGraphQL引擎编写的服务方法，可以看作具有如下函数签名</code></pre></figure> <p>javascript ApiResponse<object> service(ApiRequest&lt;Map&gt; request);</object></p> <p>class ApiRequest<t>{ Map&lt;String,Object&gt; headers; FieldSelectionBean selection; T data; }</t></p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>服务方法都是接收一个POJO的request对象，返回一个POJO的response对象。因为输入和输出都是简单对象，所以可以无需编码，只需要简单配置，就可以做到

1. 把GraphQL服务方法发布为消息队列的消费者，它从一个topic接收request对象，向另一个topic发送返回消息，如果header中标注了one-way，则忽略返回消息。

2. 将GraphQL服务方法发布为RPC服务函数

3. 从批处理文件中读取Request对象，依次调用服务方法，批量提交，失败重试，然后把返回的Response消息写入到输出文件中。

## REST Over GraphQL

GraphQL引擎可以运行在REST服务之上，提供所谓federation的功能，将多个REST服务组合为一个统一的GraphQL端点。那么反过来是不是也可以将底层的GraphQL服务方法拆解开来，暴露为一个个独立的REST资源？

NopGraphQL借助lazy字段的概念，对GraphQL类型定义Eager加载的属性集合，通过规范化的方式将GraphQL模型中的方法转化为REST服务。具体REST链接格式如下</code></pre></figure> <p>java /r/{operationName}?@selection=a,b,c{d,e}</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>1. 通过request body来传参数

2. /r/{operationName}为服务链接，通过可选的`@selection`
   参数来指定对返回结果的字段选择。如果不指定，则后台会自动返回所有没有标记为lazy的属性。代码生成的时候，关联表的数据缺省会被标记为lazy，因此它们在缺省情况下不会包含在REST调用的返回结果中。

3. GET请求只能调用GraphQL的query操作，而POST可以调用query或者mutation的操作。

可以通过URL参数来传递调用参数。例如</code></pre></figure> <p>GET /r/NopAuthUser_get?id=3</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>等价于执行 NopAuthUser\_get(id:3)。

在POST请求时可以通过http的body传送json格式的请求对象

Nop平台的前端框架在百度AMIS框架的基础上，对GraphQL调用做了进一步的简化。在前端，我们现在可以使用如下url格式来发起GraphQL调用，</code></pre></figure> <p>js api: { url: ‘@query:NopAuthUser__get/id,userName?id=$id’ }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>上面的url链接使用了所谓的前缀引导语法，底层的ajaxFetch函数会识别`@query:`前缀，并把它转化为graphql请求</code></pre></figure> <p>graphql query($id:String){ NopAuthUser_get(id:$id){ id, userName } }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>ajaxFetch识别的graphql url的格式为</code></pre></figure> <table> <tbody> <tr> <td>(@query</td> <td>@mutation):{operationName}/{selection}?参数名=参数值</td> </tr> </tbody> </table> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>当我们需要为表单或者表格编写加载函数时，如果字段比较多，则手工编写graphql请求很容易出现字段遗漏。因为Nop平台的前端代码也是自动生成的，所以我们可以利用编译期信息自动生成graphql请求，使得我们恰好只选择表单或者表格中用到的数据。具体做法是引入编译期的变量formSelection,
pageSelection等。例如</code></pre></figure> <p>js @query:NopAuthUser_get/{@formSelection}?id=$id</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>`{@formSelection}`表示选择当前表单中用到的所有字段。

## GraphQL扩展

### Map类型

GraphQL是一种强类型的框架，它要求所有数据都有明确的类型定义，这在某些动态场景中使用时并不方便。例如有的时候我们可能需要把一个扩展集合返回到前端。

NopGraphQL引入了一个特殊的Scalar类型: Map，可以利用它来描述那些动态数据结构。例如</code></pre></figure> <p>type QueryBean{ filter: Map orderBy: [OrderFieldBean] }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>### 树形结构

对于单位树、菜单树这样的树形结构的获取，NopGraphQL通过Directive机制提供了一个扩展语法，可以直接表达递归拉取数据，例如</code></pre></figure> <p>NopAuthDept_findList{ value: id, label: displayName children @TreeChildren(max=5) }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>`@TreeChild(max=5)`表示按照本层的结构最多嵌套5层。

## 文件上传下载

参见[upload.md](../upload/)

## REST链接

NopGraphQL引擎支持通过REST链接的方式调用后台服务函数。
在某种意义上它统一了GraphQL和REST，使得它们可以实现同样的功能，区别仅仅是请求和响应消息的格式不同

参见 [rest.md](../rest/)

## GraphQL结果组合

GraphQL提供了REST所不具备的结果组合能力，可以极大提升系统的可组合性和运行时性能。下面以DevDocBizModel中的实现做一个简要说明。

在前台我们可以查询后台的全局对象定义，每个全局对象具有methods属性，返回这个全局对象上所定义的方法</code></pre></figure> <p>graphql query{ DevDoc__globalVars{ name methods } }</p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>在DevDocBizModel的实现中，globalVars方法中只初始化了GlobalVarDefinition的name属性等简单属性，并没有加载复杂的methods属性。
globalVars方法返回`List&lt;GlobalVarDefinition&gt;`之后，由GraphQL引擎进行后续处理，它发现需要返回methods属性之后，会调用methods所对应的DataLoader,
实际构造`List&lt;FunctionDefBean&gt;`返回。

**如果客户端没有请求methods属性，则后台可以避免执行methods加载函数，从而提升性能**</code></pre></figure> <p>java</p> <p>@BizModel(“DevDoc”) public class DevDocBizModel { @BizQuery @Description(“全局变量”) public List<globalvariabledefbean> globalVars() { return ... }</globalvariabledefbean></p><pre><code>@BizLoader(forType = GlobalVariableDefBean.class)
public List&lt;FunctionDefBean&gt; methods(@ContextSource GlobalVariableDefBean varDef) {
    return ...
} }
</code></pre><figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>完整实现参考[DevDocBizModel.java](https://gitee.com/canonical-entropy/nop-entropy/blob/master/nop-biz/src/main/java/io/nop/biz/dev/DevDocBizModel.java){:target=&quot;_blank&quot;}{:rel=&quot;external nofollow&quot;}

## 在XBiz模型中定义Loader

在xbiz中定义query,mutation和loader与在Java中定义是等价的。例如</code></pre></figure> <p>java</p> <p>@BizModel(“NopAuthRole”) public class NopAuthRoleBizModel extends CrudBizModel<nopauthrole> { @BizLoader @GraphQLReturn(bizObjName = "NopAuthUser") public List<nopauthuser> roleUsers(@ContextSource NopAuthRole role) { return role.getUserMappings().stream().map(NopAuthUserRole::getUser) .sorted(comparing(NopAuthUser::getUserName)).collect(Collectors.toList()); } }</nopauthuser></nopauthrole></p> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>如果写到xbiz文件中，就对应如下方式</code></pre></figure> <p>xml</p> <loaders> <loader name="roleUsers"> <arg name="role" kind="ContextSource" type="io.nop.auth.dao.entity.NopAuthRole" /> <return type="List&lt;io.nop.auth.dao.entity.NopAuthUser&gt;" /> <source /> <c:script> const users = role.userMappings.map(m=&gt;m.user); return _.sortBy(users,"userName") </c:script> </loader> </loaders> <figure class="highlight"><pre><code class="language-text" data-lang="text"><span></span>注意：所有GraphQL中能够使用的属性都必须在meta中配置。仅定义loader并不会自动生成属性定义，这主要是为了保证meta模型的语义完整性。

## 通过meta的getter来实现自定义属性

有些简单的属性适配问题，如果使用xbiz中的loader机制可能觉得过于繁琐，可以直接在meta中通过getter属性来配置。</code></pre></figure> <p>xml</p> <prop name="nameEx"> <getter> <c:script> // 这里entity表示当前实体 return entity.name + 'M' </c:script> </getter> </prop> <p>```</p> </div> <footer class="Article-footer col-md-3"> <div class="Widget" data-url="/projects/nop-entropy/docs/dev-guide/graphql/graphql-java/" data-path="_knosys/project-nop-entropy/dev-guide/graphql/graphql-java.md"> <div class="Widget-body"><a href="https://gitee.com/canonical-entropy/nop-entropy/edit/master/docs/dev-guide/graphql/graphql-java.md" target="_blank" rel=" rel="external nofollow"">在 Gitee 上编辑文档内容</a></div> </div> <section class="Widget Widget--toc"> <div class="Widget-header"> <h2 class="Widget-title">目录</h2> </div> <div class="Widget-body"></div> </section> </footer> </article> <footer class="Page-footer Footer"> <div class="container-fluid"> <div class="Footer-description"> <!-- Important links --> <nav class="Footer-navs"> <ul><li><a href="/projects/nop-entropy/docs/"><span>指南</span></a> </li><li><a href="/community/"><span>社区</span></a> </li></ul> </nav> <!-- Copyright --> <div class="Footer-copyright"> <p>&copy; 2024-2024 <a href="https://nop-platform.gitee.io?utm_source=https://nop-platform.gitee.io&utm_medium=common-footer" target="_blank" rel="external nofollow">Nop 社区</a> 版权所有 </p> <p>本站主题 <a href="https://ourai.github.io/lime/?utm_source=https://nop-platform.gitee.io&utm_medium=common-footer" target="_blank" rel="external nofollow">Lime</a> 由 <a href="https://linxoid.com/ourai/?utm_source=https://nop-platform.gitee.io&utm_medium=common-footer" target="_blank" rel="external nofollow">欧雷</a> 提供</p> </div> </div> </div> </footer> </main> </div> <script>$('table').addClass('table table-bordered')</script> <script type="text/javascript" src="/assets/ksio/vendors/share.min-3155ee636b84a04d036e0f1ba833227d3fd03a4c58a6f2e21c9ceb1c5d0198c7.js"></script><script type="text/javascript" src="/assets/ksio/components-a266f21fe1dfd61bebf40e74872cbf901eb3e201f7d33e9e5d5af9a55f4b24ea.js"></script> <script type="text/javascript" src="/assets/ksio/initializers/time-8d7a529a66ae6cb53c2283d21fd6a12c538b8473dd5bd76458366d09adce7bf6.js"></script><script type="text/javascript" src="/assets/ksio/initializers/lazyload-44b7df8a9282d598284d522e64d6be9ac88d466f3c4a734a514303e99347b2c9.js"></script> </body> </html>
